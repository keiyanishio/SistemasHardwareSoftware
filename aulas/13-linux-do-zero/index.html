
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
        <meta name="author" content="Igor Montagner, Maciel Calebe Vidal">
      
      
        <link rel="canonical" href="https://insper.github.io/SistemasHardwareSoftware/aulas/13-linux-do-zero/">
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.3.0, mkdocs-material-8.3.2">
    
    
      
        <title>13 - Linux do Zero - Sistemas Hardware-Software - 2022/1</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.5d38496d.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.cbb835fc.min.css">
        
          
          
          <meta name="theme-color" content="#795649">
        
      
      
    
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../css/termynal.css">
    
    <script>__md_scope=new URL("../..",location),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Fira+Sans+Extra+Condensed:700|Oxygen+Mono|Source+Sans+Pro:700|Source+Serif+Pro&amp;display=swap">
<link rel="stylesheet" href="../../assets/css/devlife.css">


    <script>
        window.ihandout_config = JSON.parse(`{"report": {"api-base": "https://devlife.insper-comp.com.br/api/offerings/1/", "url": "https://devlife.insper-comp.com.br/api/offerings/1/exercises/"}}`);
    </script>


  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="preference" data-md-color-primary="brown" data-md-color-accent="amber">
  
    
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#13-linux-do-zero" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="Sistemas Hardware-Software - 2022/1" class="md-header__button md-logo" aria-label="Sistemas Hardware-Software - 2022/1" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Sistemas Hardware-Software - 2022/1
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              13 - Linux do Zero
            
          </span>
        </div>
      </div>
    </div>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" aria-label="Clear" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/Insper/SistemasHardwareSoftware/" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.1.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    sistemashardwaresoftware
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="Sistemas Hardware-Software - 2022/1" class="md-nav__button md-logo" aria-label="Sistemas Hardware-Software - 2022/1" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    Sistemas Hardware-Software - 2022/1
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/Insper/SistemasHardwareSoftware/" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.1.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    sistemashardwaresoftware
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        Home
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../sobre/" class="md-nav__link">
        Entregas e Prazos
      </a>
    </li>
  

    
      
      
      

  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3" type="checkbox" id="__nav_3" checked>
      
      
      
      
        <label class="md-nav__link" for="__nav_3">
          Aulas
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Aulas" data-md-level="1">
        <label class="md-nav__title" for="__nav_3">
          <span class="md-nav__icon md-icon"></span>
          Aulas
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../01-inteiros/" class="md-nav__link">
        01 - Inteiros na CPU
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../02-ram/" class="md-nav__link">
        02 - Representação de dados em RAM
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../03-arquitetura-x86/" class="md-nav__link">
        03 - Arquitetura x86-64
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../04-funcoes-mov/" class="md-nav__link">
        04 -  Funções
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../05-condicionais/" class="md-nav__link">
        05 - Condicionais
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../06-condicionais-funcoes/" class="md-nav__link">
        06 - Condicionais e funções
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../07-loops/" class="md-nav__link">
        07 - Loops
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../08-variaveis-locais/" class="md-nav__link">
        08 - Variáveis locais
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../09-arrays/" class="md-nav__link">
        09 - Array em Assembly
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../10-revisao/" class="md-nav__link">
        10 - Revisão
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../11-malloc/" class="md-nav__link">
        11 - Alocação Dinâmica de Memória
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../12-tipos-de-dados/" class="md-nav__link">
        12 - Tipos abstratos de dados
      </a>
    </li>
  

            
          
            
              
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          13 - Linux do Zero
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        13 - Linux do Zero
      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#tarefas-preliminares" class="md-nav__link">
    Tarefas preliminares
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#compilando-o-kernel" class="md-nav__link">
    Compilando o kernel
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#a-biblioteca-padrao-libc" class="md-nav__link">
    A biblioteca padrão - libc
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#nosso-primeiro-programa-hello-linux" class="md-nav__link">
    Nosso primeiro programa - Hello Linux
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#sistema-de-arquivos-e-discos-virtuais" class="md-nav__link">
    Sistema de Arquivos e discos virtuais
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../14-processos/" class="md-nav__link">
        14 - Processos
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../15-exec/" class="md-nav__link">
        15 - Carregamento de programas
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../16-entrada-saida/" class="md-nav__link">
        16 - Entrada/Saída
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../17-sinais-I/" class="md-nav__link">
        17 - Enviando sinais
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../18-sinais-II/" class="md-nav__link">
        18 - Capturando sinais
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../19-threads-I/" class="md-nav__link">
        19 - Concorrência e Threads
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../20-sincronizacao/" class="md-nav__link">
        20 - Sincronização com Mutex
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../21-semaforos/" class="md-nav__link">
        21 - Semáforos
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../22-semaforos-II/" class="md-nav__link">
        22 - Semáforos II e Modelos de concorrência
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../23-questoes-de-revisao/" class="md-nav__link">
        22 - Questões de revisão
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4" type="checkbox" id="__nav_4" >
      
      
      
      
        <label class="md-nav__link" for="__nav_4">
          Labs
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Labs" data-md-level="1">
        <label class="md-nav__title" for="__nav_4">
          <span class="md-nav__icon md-icon"></span>
          Labs
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../labs/hackerlab/" class="md-nav__link">
        Hackerlab
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../labs/processos/" class="md-nav__link">
        Immortal
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../labs/threads/" class="md-nav__link">
        K-Nearest Neighbors Classifier
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#tarefas-preliminares" class="md-nav__link">
    Tarefas preliminares
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#compilando-o-kernel" class="md-nav__link">
    Compilando o kernel
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#a-biblioteca-padrao-libc" class="md-nav__link">
    A biblioteca padrão - libc
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#nosso-primeiro-programa-hello-linux" class="md-nav__link">
    Nosso primeiro programa - Hello Linux
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#sistema-de-arquivos-e-discos-virtuais" class="md-nav__link">
    Sistema de Arquivos e discos virtuais
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content" data-md-component="content">
            <article class="md-content__inner md-typeset">
              
                
  <a href="https://github.com/Insper/SistemasHardwareSoftware/edit/master/docs/aulas/13-linux-do-zero/index.md" title="Edit this page" class="md-content__button md-icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25Z"/></svg>
  </a>



<h1 id="13-linux-do-zero">13 - Linux do Zero<a class="headerlink" href="#13-linux-do-zero" title="Permanent link">&para;</a></h1>
<h2 id="tarefas-preliminares">Tarefas preliminares<a class="headerlink" href="#tarefas-preliminares" title="Permanent link">&para;</a></h2>
<p>Vamos precisar dos seguintes softwares instalados no sistema. Como o resto do curso, os pacotes abaixo são para o Ubuntu 20.04 LTS,</p>
<div class="termy">

    <div class="highlight"><pre><span></span><code><span class="gp">$ </span>sudo apt install build-essential flex bison qemu ncurses-dev libssl-dev libelf-dev qemu-system-x86
</code></pre></div>

</div>

<div class="admonition example">
<p class="admonition-title">Example</p>
<p>Instale os pacotes acima no seu sistema.</p>
</div>
<h2 id="compilando-o-kernel">Compilando o kernel<a class="headerlink" href="#compilando-o-kernel" title="Permanent link">&para;</a></h2>
<p>Vamos primeiro fazer o download do kernel do Linux no <a href="https://www.kernel.org/">site oficial</a>(<a href="https://www.kernel.org/">https://www.kernel.org/</a>). Podem baixar a versão estável mais recente (atualmente<code>5.17.3</code>)</p>
<div class="admonition example">
<p class="admonition-title">Example</p>
<p>Decompacte o arquivo baixado e examine os arquivos na pasta criada.</p>
<div class="termy">
<div class="highlight"><pre><span></span><code><span class="gp">$ </span>tar xvf linux-X.Y.Z.tar.xz
</code></pre></div>
</div>
</div>
<p>Isto criará uma pasta <code>linux-X.Y.Z</code> que contém os fontes de todo o kernel. O kernel pode ser compilado com uma quantidade enorme de configurações diferentes, sendo que a configuração atual é salva no arquivo <code>.config</code> dentro da pasta do código fonte.</p>
<div class="admonition example">
<p class="admonition-title">Example</p>
<p>Compile um kernel com as opções padrão usando o  comando.</p>
<div class="termy">
<div class="highlight"><pre><span></span><code><span class="gp">$ </span>make defconfig
</code></pre></div>
</div>
</div>
<div class="admonition example">
<p class="admonition-title">Example</p>
<p>Podemos customizar as configurações disponíveis usando o comando abaixo. Execute-o e explore um pouco as possibilidades.</p>
<div class="termy">
<div class="highlight"><pre><span></span><code><span class="gp">$ </span>make menuconfig
</code></pre></div>
</div>
</div>
<div class="admonition example">
<p class="admonition-title">Example</p>
<p>Habilite a opção <em>Linux guest support</em> dentro de <em>Processor Type and Features</em>.</p>
</div>
<div class="admonition example">
<p class="admonition-title">Example</p>
<p>Para compilar seu kernel, execute:</p>
<div class="termy">
<div class="highlight"><pre><span></span><code><span class="gp">$ </span>make -j8
</code></pre></div>
</div>
</div>
<p>O exercício acima demora em torno de 10~20 minutos. Enquanto ele acontece, siga a próxima seção.</p>
<h2 id="a-biblioteca-padrao-libc">A biblioteca padrão - <code>libc</code><a class="headerlink" href="#a-biblioteca-padrao-libc" title="Permanent link">&para;</a></h2>
<p>A biblioteca padrão <em>C</em> é contém uma função em <em>C</em> para cada chamada de sistema disponível e interpreta os códigos de erro, deixando-os em um formato (um pouco) mais amigável. Como vimos em aula, realizar chamadas de sistema é uma tarefa que depende do hardware e por isso é diferente em cada arquitetura (ARM vs x86, por exemplo). Logo, a <code>libc</code> oferece uma camada de abstração maior acima do sistema operacional, já que programas construídos usando suas função são portáveis em nível de código fonte. Ou seja, necessitando somente a recompilação do executável para funcionar em outras plataformas. Ela também oferece as funcionalidades necessárias para carregar dinamicamente bibliotecas <code>.so</code>, como vimos na aula 11. Por outro lado, além do kernel precisamos portar a <code>libc</code> também cada vez que trabalhamos com arquiteturas novas.</p>
<p>Neste exemplo iremos usar a <code>glibc</code>, implementação feita pela GNU e usada na maioria das distribuições. Desta vez não precisamos compilar nada: ela já está instalada no nosso sistema e podemos simplesmente usá-la na próxima parte.</p>
<h2 id="nosso-primeiro-programa-hello-linux">Nosso primeiro programa - Hello Linux<a class="headerlink" href="#nosso-primeiro-programa-hello-linux" title="Permanent link">&para;</a></h2>
<div class="admonition example">
<p class="admonition-title">Example</p>
<p>Crie um programa que mostra a mensagem <em>Hello Linux (seu nome)</em>.</p>
</div>
<p>Para compilar nosso programa vamos usar a flag especial <code>-static</code>. Ao habilitá-la criaremos um executável totalmente autocontido, que pode ser executado sem nenhuma dependência.</p>
<div class="admonition example">
<p class="admonition-title">Example</p>
<p>Compile o programa usando o comando abaixo.</p>
<div class="termy">
<div class="highlight"><pre><span></span><code><span class="gp">$ </span>gcc -Og -Wall -static hello_linux.c -o hello
</code></pre></div>
</div>
<p>Execute-o e veja que tudo funciona normalmente.</p>
</div>
<p>Bom, não vemos nenhuma diferença com o comportamento usual. Vamos então aprender a listas as dependências de executáveis.</p>
<div class="admonition example">
<p class="admonition-title">Example</p>
<p>Compile seu programa "normalmente" (sem <code>-static</code>) e chame-o de <code>hello-dyn</code>.</p>
</div>
<p>Podemos checar quais são as dependências de um executável com o comando <code>ldd</code>.</p>
<div class="admonition example">
<p class="admonition-title">Example</p>
<p>Execute o seguinte comando e veja sua saída:</p>
<div class="termy">
<div class="highlight"><pre><span></span><code><span class="gp">$ </span>ldd ./hello-dyn
</code></pre></div>
</div>
</div>
<div class="admonition example">
<p class="admonition-title">Example</p>
<p>Execute <code>ldd</code> no arquivo <code>hello</code> (compilado com <code>static</code>) e veja sua saída:</p>
<div class="termy">
<div class="highlight"><pre><span></span><code><span class="gp">$ </span>ldd ./hello
</code></pre></div>
</div>
</div>
<p>No primeiro caso deverão ter aparecido alguns arquivos listados como dependências, enquanto no segundo a saída deverá ser vazia. Antes de rodar <code>hello-dyn</code> o Linux garante que todos os arquivos listados no exercício anterior estão carregados na memória também. Por esta razão, cada arquivo <code>.so</code> listado é chamado de <strong>dependência</strong> de <code>hello-dyn</code>.</p>
<p>!!! tip "Agora seu sistema já deve ter acabado de compilar o kernel.</p>
<div class="admonition example">
<p class="admonition-title">Example</p>
<p>Verifique que foi criado o arquivo <code>bzImage</code> na pasta <code>linux-X.Y.Z/arch/x86_64/boot/</code>. Este é o arquivo executável contendo o kernel Linux que compilamos.</p>
</div>
<h2 id="sistema-de-arquivos-e-discos-virtuais">Sistema de Arquivos e discos virtuais<a class="headerlink" href="#sistema-de-arquivos-e-discos-virtuais" title="Permanent link">&para;</a></h2>
<p>Agora que já temos um kernel e um programa que será rodado pelo nosso sistema, vamos criar a primeira versão do disco de nosso sistema. Nossa primeira organização do sistema será incrivelmente minimal e rudimentar. Nosso sistema disco conterá apenas um arquivo: o executável <code>hello</code> criado no item anterior.</p>
<p>Vamos começar criando um arquivo vazio de <em>100Mb</em> que será usado como nosso diretório raiz <code>/</code>.</p>
<div class="admonition example">
<p class="admonition-title">Example</p>
<p>Crie um arquivo</p>
<div class="termy">
<div class="highlight"><pre><span></span><code><span class="gp">$ </span>dd <span class="k">if</span><span class="o">=</span>/dev/zero <span class="nv">of</span><span class="o">=</span>raiz.img <span class="nv">bs</span><span class="o">=</span>1M <span class="nv">count</span><span class="o">=</span><span class="m">100</span>
</code></pre></div>
</div>
</div>
<p>Antes de continuar, precisamos expor o arquivo acima como um dispositivo de armazenamento para o restante do sistema. Podemos fazer isto usando um <em>loopback device</em>. Este tipo de dispositivo se comporta igual a um disco físico, mas modifica os bytes de um arquivo ao invés de interagir com hardware. O comando <code>losetup</code> é usado para fazer este serviço.</p>
<!-- 
!!! warning
    Todo comando cujo prompt começa com `#` deverá ser executado como *root*. Você pode fazer isso colocando `sudo` na frente de todos esses comandos. -->

<div class="termy">

<div class="highlight"><pre><span></span><code><span class="gp">$ </span>sudo losetup -P -f --show raiz.img
</code></pre></div>

</div>

<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>O comando acima mostra o número do dispositivo criado. Anota para os próximos passos!</p>
</div>
<p>Agora podemos criar uma <em>tabela de partições</em>. Esta estrutura, gravada no começo de um disco, contém informações que permitem identificar quais <em>partições</em> estão presentes, seus tamanhos e tipo. Em sua essência, uma <em>partição</em> é somente uma subdivisão de um disco físico. Isto ajuda, por exemplo, a instalar vários SOs no mesmo disco sem precisar ter um disco separado para cada sistema. Fazemos tudo isto usando o comando <code>fdisk</code>:</p>
<div class="termy">

<div class="highlight"><pre><span></span><code><span class="gp">$ </span>sudo fdisk /dev/loop0
</code></pre></div>

</div>

<p>O <code>fdisk</code> trabalha como um prompt de comandos. Digite <code>m</code> para conhecer as opções.</p>
<div class="admonition example">
<p class="admonition-title">Example</p>
<p>Crie uma partição (comando <code>n</code>) neste disco ocupando todo o espaço disponível. As opções padrão do comando de criar partições são adequadas para nosso uso.</p>
</div>
<div class="admonition example">
<p class="admonition-title">Example</p>
<p>Use o comando <code>p</code> para mostrar o estado atual do disco. Certifique-se de que há uma partição do tipo <em>Linux</em> que ocupe o disco todo. Anote o valor do campo <em>Disk Identifier</em>.</p>
</div>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>O <em>Disk Identifier</em> será utilizado sem o <code>0x</code> nos próximos passos.</p>
</div>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Não se esqueça de usar o comando <code>w</code> para salvar as partições criadas antes de sair. Caso contrário, terá que refazer!</p>
</div>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Em Linux um arquivo é simplesmente uma sequência de bytes. Se eu pedir para o sistema interpretar esta sequência como um disco formatado no padrão <em>ext4</em> isto terá o mesmo efeito que se essa sequência de bytes estivesse armazenada diretamente em um disco físico.</p>
</div>
<p>A partir de agora, o dispositivo <em>/dev/loop0</em> (ou algo similar que tenha sido retornado pelo comando acima) é equivalente a um disco físico. Assim como localizamos a primeira partição de um disco usando <code>/dev/sda1</code>, localizamos a primeira partição do nosso <em>loop device</em> usando <code>/dev/loop0p1</code>.</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Se você só tem <code>/dev/loop0/</code> e não possui <code>/dev/loop0p1</code> então houve algo errado com a criação das partições de seu disco. Refaça tudo a partir do comando <code>dd</code>.</p>
</div>
<div class="admonition example">
<p class="admonition-title">Example</p>
<p>Vamos agora formatar essa partição e montá-la no diretório <em>raiz_linux</em>.</p>
<div class="termy">
<div class="highlight"><pre><span></span><code><span class="gp">$ </span>sudo mkfs.ext4 /dev/loop0p1
<span class="gp">$ </span>sudo mkdir raiz_linux
<span class="gp">$ </span>sudo mount -t ext4 /dev/loop0p1 raiz_linux
</code></pre></div>
</div>
</div>
<p>Tudo o que for escrito na pasta <em>raiz_linux</em> será escrito diretamente no nosso arquivo <em>raiz.img</em> da mesma maneira que seria escrito em um disco físico. No nosso caso, tudo o que for colocado nesta pasta estará presente no diretório <code>/</code> do nosso sistema Linux.</p>
<div class="admonition example">
<p class="admonition-title">Example</p>
<p>Copie seu executável <code>hello</code> para o nosso disco virtual montado em <code>raiz_linux</code>.</p>
<div class="termy">
<div class="highlight"><pre><span></span><code><span class="gp">$ </span>sudo cp hello raiz_linux/
</code></pre></div>
</div>
</div>
<h1 id="seu-primeiro-boot">Seu primeiro boot<a class="headerlink" href="#seu-primeiro-boot" title="Permanent link">&para;</a></h1>
<p>Com isto já temos o mínimo necessário para dar <em>boot</em> no sistema, mas não teremos um sistema completamente funcional nem bem montado. Na verdade, nosso SO agora é completamente capenga e tem um zilhão de problema.</p>
<p>A instalação de um <em>boot loader</em> é trabalhosa e cheia de possibilidades de erros. Podemos aproveitar o fato do próprio <em>QEmu</em> servir de <em>boot loader</em> para facilitar o desenvolvimento deste roteiro.</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Sempre que for usar o <code>qemu</code> não se esqueça de desvincular <code>/dev/loop0p1</code> de <code>raiz_linux</code> usando <code>umount</code>.</p>
<div class="termy">
<div class="highlight"><pre><span></span><code><span class="gp">$ </span>sudo umount raiz_linux
</code></pre></div>
</div>
</div>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>Você pode checar os discos que estão montados no momento usando o comando <code>lsblk</code></p>
</div>
<p>Nosso comando de boot terá o formato abaixo:</p>
<p><div class="highlight"><pre><span></span><code>$ sudo qemu-system-x86_64 \
                     -nographic \
                     -kernel linux-X.Y.Z/arch/x86_64/boot/bzImage \
                     -append &quot;quiet init=/hello root=PARTUUID=XXXXXXXX-01 console=ttyS0&quot; \
                     /dev/loop0
</code></pre></div>
Vamos destrinchar essa chamada:</p>
<ul>
<li><code>-kernel linux-X.Y.Z/arch/x86_64/boot/bzImage</code>: instrui o <em>QEmu</em> a carregar o kernel presente no caminho passado.</li>
<li><code>-nographic</code> pede para o QEmu uma sessão modo texto.</li>
<li><code>-append "quiet init=/hello root=PARTUUID=XXXXXXXX-01 console=ttyS0"</code>: estas opções são passadas para o kernel e configuram sua execução<ul>
<li><code>quiet</code>: minimiza mensagens de debug</li>
<li><code>init=/hello</code>: aqui configuramos o primeiro programa rodado pelo nosso kernel Linux</li>
<li><code>root=PARTUUID=XXXXXXXX-01</code>: sistema de arquivos raiz está na partição <code>01</code> do disco identificado pelo <code>UUID</code> que vocês obtiveram no <code>fdisk</code></li>
<li><code>console-ttyS0</code> cria um interface de texto serial parecida com a que vocês usam em embarcados para mostrar <code>printf</code> no PC.</li>
</ul>
</li>
<li><code>/dev/loop0</code>: disco a ser colocado na máquina virtual. O <em>Disk Identifier</em> dele (anotado anteriormente) está listado no item acima.</li>
</ul>
<div class="admonition example">
<p class="admonition-title">Example</p>
<p>Adapte o comando acima para usar o disco criado por você e execute-o.</p>
</div>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>No comando, na parte <code>root=PARTUUID=XXXXXXXX-01</code>, substitua <code>XXXXXXXX</code> pelo <em>Disk Identifier</em> anotado anteriormente. Se o <em>Disk Identifier</em> anotado foi <code>0xbd624993</code>, utilize <code>root=PARTUUID=bd624993-01</code>. Perceba que não utilizamos <code>0x</code>.</p>
</div>
<p>Se tudo der certo, você verá algo como abaixo:</p>
<div class="highlight"><pre><span></span><code>(várias mensagens do QEMu aqui)
Hello linux maciel
[    2.636091] Kernel panic - not syncing: Attempted to kill init! exitcode=0x00000000
[    2.640952] CPU: 0 PID: 1 Comm: hello Not tainted 5.11.16 #1
[    2.641747] Hardware name: QEMU Standard PC (i440FX + PIIX, 1996), BIOS 1.10.2-1ubuntu1 04/01/2014
(... erros continuam ...)
</code></pre></div>
<div class="admonition example">
<p class="admonition-title">Example</p>
<p>Procure na saída do seu QEmu o print do seu executável <code>hello</code>. Veja que o Linux carregou seu programa na memória e o executou!</p>
</div>
<div class="admonition warning">
<p class="admonition-title">Se algo deu errado aqui chame o professor para te ajudar a encontrar o problema.</p>
</div>
<p>Logo em seguida temos uma mensagem chamada <em>Kernel panic</em>. Ela acontece quando ocorre um erro irrecuperável no Linux e o sistema simplesmente para. No nosso caso o erro é <em>Attempted to kill init!</em>.</p>
<p>Na linha do QEmu apontamos nosso programa <code>hello</code> no parâmetro <code>init</code>. O programa apontado por <code>init</code> é especial: ele nunca termina e representa aquele <code>while(1)</code> que vocês já devem ter usado muito em embarcados. Enquanto o sistema estiver ligado o <code>init</code> está executando e "tomando conta" de todos os outros programas que estão rodando.</p>
<p>Bom, <code>init</code> nunca deveria terminar e o nosso termina logo após de dar um <code>print</code>. Vamos consertar isso mais para a frente.</p>
<div class="admonition done">
<p class="admonition-title">Done</p>
<p>Você conseguiu seu primeiro boot! Pode agora sair do QEmu digitando <code>Ctrl+A X</code>.</p>
</div>
<h2 id="organizando-os-arquivos">Organizando os arquivos<a class="headerlink" href="#organizando-os-arquivos" title="Permanent link">&para;</a></h2>
<p>Atualmente nosso sistema só tem um único arquivo: o executável <code>hello</code>. Claramente isso não é nem útil nem desejável. Sistemas baseados em Linux seguem uma organização (relativamente) padrão do arquivos no sistema raiz. Uma descrição formal desse padrão pode ser vista no <a href="https://refspecs.linuxfoundation.org/FHS_3.0/fhs-3.0.pdf">site da Linux Foundation</a>, mas vamos nos contentar lendo uma introdução breve.</p>
<div class="admonition example">
<p class="admonition-title">Example</p>
<p>Leia o artigo <a href="https://en.wikipedia.org/wiki/Filesystem_Hierarchy_Standard">Filesystem Hierarchy Standard</a>.</p>
</div>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>A hierarquia de diretórios não representa (necessariamente) um disco físico, mas sim uma organização das informações disponíveis no sistema. Como vimos com o arquivo <code>raiz.img</code>, podemos "pendurar" o conteúdo de um disco em basicamente qualquer diretório.</p>
</div>
<p>Claramente nosso sistema não obedece ao padrão acima.</p>
<div class="admonition example">
<p class="admonition-title">Example</p>
<p>Crie manualmente as pastas mostradas acima usando <code>mkdir</code>. Ao dar <code>ls -l</code> você deverá ver o seguinte:</p>
<div class="highlight"><pre><span></span><code>drwxr-xr-x 2 root root  1024 abr 30 09:46 bin
drwxr-xr-x 2 root root  1024 abr 30 09:46 boot
drwxr-xr-x 2 root root  1024 abr 30 09:46 dev
drwxr-xr-x 2 root root  1024 abr 30 09:46 etc
drwxr-xr-x 2 root root  1024 abr 30 09:46 home
drwxr-xr-x 2 root root  1024 abr 30 09:46 lib
drwx------ 2 root root 12288 abr 30 09:39 lost+found
drwxr-xr-x 2 root root  1024 abr 30 09:46 proc
drwxr-xr-x 2 root root  1024 abr 30 09:46 root
drwxr-xr-x 2 root root  1024 abr 30 09:46 run
drwxr-xr-x 2 root root  1024 abr 30 09:46 sbin
drwxr-xr-x 2 root root  1024 abr 30 09:46 sys
drwxr-xr-x 2 root root  1024 abr 30 09:46 tmp
drwxr-xr-x 7 root root  1024 abr 30 09:46 usr
drwxr-xr-x 2 root root  1024 abr 30 09:46 var
</code></pre></div>
</div>
<p>Uma outra parte do padrão corresponde a qual é lugar padrão do <code>init</code>. Tradicionalmente este programa está localizado no caminho <code>/sbin/init</code>. O parâmetro <code>init=/hello</code> que passamos para o Qemu sobrescreve este comportamento, porém ele não é normalmente usado em sistemas Linux.</p>
<div class="admonition example">
<p class="admonition-title">Example</p>
<p>Mova <code>hello</code> para <code>/sbin/init</code> e execute novamente o Qemu, desta vez sem o parâmetro <code>init=...</code> no kernel.</p>
</div>
<div class="admonition done">
<p class="admonition-title">Done</p>
<p>Agora que temos nosso sistema Linux minimamente funcional construído inteiramente do zero estamos prontos para começar a explorar seus recursos e possibilidades.</p>
</div>
<h2 id="avancado">Avançado<a class="headerlink" href="#avancado" title="Permanent link">&para;</a></h2>
<p>Você notou que até agora só usamos <code>hello</code>? E o que fizemos com o <code>hello-dyn</code>?</p>
<div class="admonition example">
<p class="admonition-title">Example</p>
<p>Tente usar <code>hello-dyn</code> no lugar de <code>hello</code> como <code>init</code>. Funciona?</p>
</div>
<p>Você deve perceber que nosso sistema funciona menos ainda com <code>hello-dyn</code>. Isto ocorre pois <strong>não instalamos nenhuma das dependências</strong> dele. Aqueles arquivos listados pelo <code>ldd</code> precisam estar disponíveis no sistema de arquivos para que ele funcione!</p>
<div class="admonition example">
<p class="admonition-title">Example</p>
<p>Siga os passos abaixo</p>
<ol>
<li>Faça uma lista dos arquivos necessários e de suas localizações.</li>
<li>Copie-os para o sistema de arquivos em <code>raiz-linux</code> usando o terminal.</li>
<li>Copie <code>hello-dyn</code> para o nosso sistema de arquivos.</li>
<li>Inicie o qemu como <code>init</code> apontando para <code>hello-dyn</code>.</li>
</ol>
</div>
<div class="admonition done">
<p class="admonition-title">Done</p>
<p>Pronto! Agora nosso sistema tem também as dependências básicas para rodar programas no terminal! Iremos examinar bibliotecas compartilhadas mais para a frente de novo.</p>
</div>
<!---


Vamos agora copiar para *raiz_linux* o mínimo necessário para conseguirmos ligar nosso sistema em um prompt de comando *bash* como *root*. Várias coisas estarão faltando, mas já conseguiremos

O primeiro passo é montar a hierarquia de arquivos descrita no primeiro exercício desta seção. A lista completa pode ser vista neste link](https://en.wikipedia.org/wiki/Filesystem_Hierarchy_Standard).

!!! example
    Crie as pastas descritas no documento acima. Verifique que todas foram criadas rodando `ls -l` em `raiz_linux`. As pastas que você criou deverão ser as seguintes:

    <div class="highlight"><pre><span></span><code>drwxr-xr-x 2 root root  1024 abr 30 09:46 bin
drwxr-xr-x 2 root root  1024 abr 30 09:46 boot
drwxr-xr-x 2 root root  1024 abr 30 09:46 dev
drwxr-xr-x 2 root root  1024 abr 30 09:46 etc
drwxr-xr-x 2 root root  1024 abr 30 09:46 home
drwxr-xr-x 2 root root  1024 abr 30 09:46 lib
drwx------ 2 root root 12288 abr 30 09:39 lost+found
drwxr-xr-x 2 root root  1024 abr 30 09:46 proc
drwxr-xr-x 2 root root  1024 abr 30 09:46 root
drwxr-xr-x 2 root root  1024 abr 30 09:46 run
drwxr-xr-x 2 root root  1024 abr 30 09:46 sbin
drwxr-xr-x 2 root root  1024 abr 30 09:46 sys
drwxr-xr-x 2 root root  1024 abr 30 09:46 tmp
drwxr-xr-x 7 root root  1024 abr 30 09:46 usr
drwxr-xr-x 2 root root  1024 abr 30 09:46 var
</code></pre></div>

!!! example
    Dê permissões totais para a pasta `tmp` e somente para o usuário dono na pasta `root`.

    <div class="highlight"><pre><span></span><code>#&gt; chmod 777 tmp
#&gt; chmod 600 root
</code></pre></div>

!!! example
    Copie seu kernel para a pasta `boot` e o executável do *busybox* para a pasta `usr/bin`.

Como vimos anteriormente, o *busybox* contém todas as ferramentas de usuário em um único executável. Porém, não é nada prático digitar *busybox* antes de **todo comando**. Por isso criaremos uma série de links simbólicos que ligam o nome de cada ferramenta oferecida pelo *busybox* ao seu nome "tradicional".


!!! example
    Execute o comando abaixo na dentro de `raiz_linux`.

    <div class="highlight"><pre><span></span><code>for util in $(./usr/bin/busybox --list-full); do
 ln -s /usr/bin/busybox $util
done
</code></pre></div>

!!! example
    Liste os arquivos em `raiz_linux/bin`, `raiz_linux/usr/bin` e `raiz_linux/sbin` e veja quais programas estarão disponíveis no nosso sistema.

!!! example
    Copie `hello-static` e `hello-dyn` para a pasta `raiz_linux/root`.



!!! done
    Não funcionou? Perfeito! Na próxima aula transformaremos nosso sistema capenga em um sistema mínimo e totalmente funcional.

## Inicialização do sistema - `init`

Se você explorou um pouco o sistema criado na parte anterior já deve ter notado que várias coisas não funcionam. Não conseguimos, por exemplo, escrever em nenhum arquivo. Vamos explorar dois casos mais interessantes:

!!! example
    O comando `df` (*disk free*) é usado para listar o espaço livre em todos os discos presentes no sistema. Tente executá-lo no seu sistema. O quê acontece?

!!! example
    O comando `lspci` (*list pci devices*) mostra todos os periféricos ligados diretamente na placa mãe do seu PC. Tente executá-lo no seu sistema. O quê acontece?

!!! question short
    Consulte as pastas apontadas nos itens anteriores. Elas tem conteúdo? Elas *deveriam* ter conteúdo?

Para conseguirmos testar logo, adicionamos ao kernel o parâmetro `init=/bin/sh`. Este parâmetro diz para o kernel abrir um *shell* assim que iniciar. Isto também é fonte de nossos problemas, já que nosso sistema não inicializa automaticamente nenhum serviço essencial para seu funcionamento. Ou seja, nosso sistema está capenga pois ele não possui um processo `init`, que é responsável por supervisionar a criação de todos os sistemas de arquivos especiais (`/proc, /sys, /dev/`) e por iniciar serviços essenciais para o funcionamento do sistema. Da mesma maneira, ao finalizar ele é responsável por desligar todos os recursos de hardware de maneira segura.


!!! example
    Além de ser usado para mídias removíveis, o comando `mount` também é usado para criar os diretórios especiais `/proc` e `/sys`. Rode os seguintes comandos e verifique que agora `df` e `lspci` funcionam corretamente.

    <div class="highlight"><pre><span></span><code>#&gt; mount -t proc proc /proc -o nosuid,noexec,nodev
#&gt; mount -t sysfs sys /sys -o nosuid,noexec,nodev
</code></pre></div>

!!! question short
    Qual o papel das pastas especias `/proc` e `/sys` em um sistema Linux?

Estes comandos fazem parte da inicialização normal de um sistema e expõe estruturas do kernel para o resto do sistema via arquivos. O *busybox* já nos fornece um sistema de inicialização bastante simplificado que, entre outras coisas, rodaria estes comandos automaticamente a todo boot. Aproveitaremos ele para três propósitos:

1. executar um script de inicialização que configure todos os diretórios especiais e serviços.
1. adicionar serviços que proveem uma tela de login
1. executar um script de finalização que desliga o hardware quando o PC for desligado.

Primeiro vamos copiar versões padrão de todos os arquivos de configuração necessários. Os seguintes arquivos estão na pasta `configs` do repositório da aula.

* `passwd, shadow, groups`: listam os usuários e grupos presentes. `shadows` contém hashes das senha.
* `profile`: é executado logo após um login correto. Pode ser usado para configurar o terminal.
* `issue`: contém o nome do seu sistema mostrado na tela de login.
* `hosts`: associa um nome com alguns IPs. É aqui que associamos *localhost* a `127.0.0.1`
* `hostname`: configura o nome da nossa máquina na rede.
* `fstab`: lista todos os discos que devem ser montados além do *rootfs*.

!!! example
    Copie estes arquivos para o `etc` do seu sistema.

O sistema de `init` disponibilizado pelo *busybox* lê o arquivo `/etc/inittab` e o interpreta de acordo com as regras mostradas no arquivo *busybox-1.30.1/examples/inittab*. Iremos usar o arquivo disponível em `configs/inittab`.

!!! question
    Leia o arquivo `config/inittab` e tente interpretar seu conteúdo.

A primeira coluna do arquivo mostra o momento em que ela deve rodar. Vemos, por exemplo, que o script `/etc/init.d/startup` rodará ao inicializar o sistema e que toda vez que o processo `/sbin/getty` (terminal com login) terminar ele é reiniciado. Também existem scripts para serem rodados ao desligar o sistema.

Em especial, este arquivo `/etc/init.d/startup` (presente no repositório como `configs/init.d/startup`) contém comandos para configurar o sistema, incluindo os diretórios especiais que mostramos acima. Seu conteúdo é mostrado abaixo por completude.

<div class="highlight"><pre><span></span><code><span class="c1"># Monta os sistemas de arquivos especiais</span>
mount -t proc proc /proc -o nosuid,noexec,nodev
mount -t sysfs sys /sys -o nosuid,noexec,nodev

<span class="c1"># Configura detector de dispositivos</span>
mkdir -p /dev/pts /dev/shm
mount -t tmpfs shm /dev/shm -o <span class="nv">mode</span><span class="o">=</span><span class="m">1777</span>,nosuid,nodev
mdev -s
<span class="nb">echo</span> /sbin/mdev &gt; /proc/sys/kernel/hotplug

<span class="c1"># Configura terminais</span>
mount -t devpts devpts /dev/pts -o <span class="nv">mode</span><span class="o">=</span><span class="m">0620</span>,gid<span class="o">=</span><span class="m">5</span>,nosuid,noexec

<span class="c1"># Configura /run, que guarda algumas informações de execução.</span>
mount -t tmpfs run /run -o <span class="nv">mode</span><span class="o">=</span><span class="m">0755</span>,nosuid,nodev

<span class="c1"># Atribui nome ao PC</span>
cat /etc/hostname &gt; /proc/sys/kernel/hostname

<span class="c1"># Monta todos os sistemas de arquivos contidos em /etc/fstab</span>
mount -a

mount -o remount,rw /
</code></pre></div>

!!! example
    Este script requer a criação de um diretório `/run`. Para que ele serve? Crie-o e copie ambos arquivos acima para seu sistema.

Agora vamos rodar de novo, desta vez com nosso novo sistema de inicialização configurado.
!!! example
    Modifique sua linha de comando do *QEmu* e retire a porção `init=/bin/sh`. Por padrão o kernel buscará o executável `/sbin/init`, que usará os arquivos que criamos para inicializar o sistema.

!!! tip
    Se tudo deu certo você deverá ter um prompt de login. Logue como *root* e continue o roteiro.

!!! warning
    Não se esqueça de usar `umount` para desmontar a pasta `raiz_linux`.

!!! example
    Crie um arquivo dentro de seu sistema. Você pode usar o editor `vi` ou o comando `touch` para criar um arquivo vazio. Se não deu certo revise se ocorreu tudo certo na execução do seu script `startup` rolando a tela para cima com `Shift+PageUp`.

!!! example
    Desligue seu sistema com `poweroff`. Ligue-o novamente e confira se o arquivo ainda está lá.

# Parte 7 - bibliotecas e carregamento dinâmico

Quando compilamos o *busybox* habilitamos uma opção que pedia executáveis compilados estaticamente, fazendo que o executável criado não tenha dependências. Vamos agora aprender a configurar nosso sistema para rodar executáveis com dependências.

!!! example
    Copie os executáveis `hello-static` e `hello-dyn` para sua VM. Não se esqueça de adicionar permissões de execução para eles.

!!! question short
    Tente rodar ambos executáveis. Ambos funcionam? Anote abaixo o resultado da execução de cada um.

Todos os executáveis que conseguimos rodar até agora foram compilados estaticamente. Quando tentamos rodar `hello-dyn` tivemos um erro.

!!! question
    Execute (em seu sistema) `ldd` em `hello-dyn`. Anote abaixo as dependências encontradas.

!!! example
    Os arquivos acima existem na sua VM?


Ao montar nosso sistema do zero não incluimos nenhuma biblioteca! Logo, o nosso executável não consegue carregar as partes faltantes e não irá rodar. Felizmente, nosso sistema Linux possui a mesma arquitetura do Ubuntu instalado em nossas máquinas e podemos copiar os arquivos necessários para nosso sistema!


!!! example
    Copie os arquivos acima para os locais indicados na saída de `ldd`.

!!! example
    Teste novamente `hello-dyn`. Agora ele funciona?

Gerenciar **dependências** é a principal atribuição de gerenciadores de pacotes como `apt`, `pacman` e `dnf`. Eles estruturam todos os softwares instaláveis em um sistema de modo que ao instalar um programa todas as suas dependências sejam instaladas também.

!!! done
    Pronto! Agora temos um sistema mínimo e funcional. Ainda faltam vários pedaços que normalmente compõem um sistema, como um bootloader instalado na imagem de disco e um gerenciador de pacotes. Mas ao menos agora ele é plenamente funcional dentro do que propomos.
    -->

  <hr>
<div class="md-source-file">
  <small>
    
      Last update:
      <span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-date">June 6, 2022</span>
      
    
  </small>
</div>

              
            </article>
            
          </div>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
    
    <nav class="md-footer__inner md-grid" aria-label="Footer" >
      
        
        <a href="../12-tipos-de-dados/" class="md-footer__link md-footer__link--prev" aria-label="Previous: 12 - Tipos abstratos de dados" rel="prev">
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
          </div>
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Previous
              </span>
              12 - Tipos abstratos de dados
            </div>
          </div>
        </a>
      
      
        
        <a href="../14-processos/" class="md-footer__link md-footer__link--next" aria-label="Next: 14 - Processos" rel="next">
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Next
              </span>
              14 - Processos
            </div>
          </div>
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4Z"/></svg>
          </div>
        </a>
      
    </nav>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    <script id="__config" type="application/json">{"base": "../..", "features": [], "search": "../../assets/javascripts/workers/search.b028fd86.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version.title": "Select version"}}</script>
    
    
      <script src="../../assets/javascripts/bundle.7f366e99.min.js"></script>
      
        <script src="https://cdnjs.cloudflare.com/ajax/libs/js-yaml/4.0.0/js-yaml.min.js"></script>
      
        <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
      
        <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
      
        <script src="https://cdn.jsdelivr.net/gh/insper-education/active-handout-plugins-js@main/package/plugin-bundle.js"></script>
      
        <script src="../../js/termynal.js"></script>
      
        <script src="../../js/custom.js"></script>
      
    
  </body>
</html>